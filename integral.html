<!DOCTYPE html>
<html>
	<head>
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>聚车金融</title>
	 	<link href="css/mui.min.css" rel="stylesheet"/>
	    <link href="css/css.css" rel="stylesheet" type="text/css">
	    <link href="css/integral.css" rel="stylesheet" type="text/css">
	    <link href="css/layer.css" rel="stylesheet"/>  
	    <script src="js/mui.min.js"></script>
	    <script src="js/api.js"></script>
	    <script src="js/common.js"></script>
	    <script type="text/javascript" src="js/layer.js" ></script>
	  	<script src="js/jquery-1.11.2.min.js"></script>
	  	
	    <style>
	        body{ 
	        	background-color:#FFFFFF;	
	        }
	        .layermanim{
	        	border-radius: 10px;	
	        }	
	    	.layermchild h3{
	    		border-bottom: none;	 
	    	}
	    	.layermcont{
	    		margin-top: -24px;	
	    	}
	    	.layermend::after, .layermend::before{
	    		width: 30px;	
	    	}
	    	.layermend {
			    position: absolute;
			    right: 16px;
			    top: 11px;
			    width:36px;    
	   		}
	   		.layermend::after, .layermend::before {
	   			 width: 30px;
	    	} 
	    </style>
	</head>
	<body>
		<div class="mui-content" style="background-color: #fff;" >
			<div id="pullrefresh" class="mui-content mui-scroll-wrapper" >
				<div class="mui-scroll" style="top: 0;bottom: -55px;background-color: #fff;">
				    <div class="integral-main" style="background-color: #fff;">      
				    	<div class="integral-fen">
				    		<h5 class="integral-title">我的积分</h5> 
				    		<div class="integral-zong">0</div>
				    		<div class="integral-ts">随机获取5-30积分</div> 
				    	</div>
				    	<p class="integral-gz"><a id="turnRule" href="rule.html"><span class="integral-gzico"></span>规则说明</a></p>
				    	<a class="integral-botton" id='getSign' style="display: none;">签到领积分</a>
				    	<a class="integral-yqd" style="display: none;">已签到</a>
				    </div>
				</div>
			</div>
		</div>
		<script src="js/scrollNum.js"></script>
		<script>
			mui.init({
				/*pullRefresh: {
					container: '#pullrefresh'
					//针对华为手机
					down: {	 
						callback: pulldownRefresh
					}
				}*/
			});
			/**
			 * 下拉刷新具体业务实现
			 */
			function pulldownRefresh() {
				//获取所有积分
				
				/*request={'user_id': user.uid(),'type_nid':'sign'};
				credit.GetTypeCount({'request':request},function(res1){
					if(res1==null){
						$(".integral-zong").html("0")
					}else{
						request2={'user_id': user.uid(),'type_nid':'sign_reward'};
						credit.GetTypeCount({'request':request2},function(res2){
							console.log(res2)
							if(res2==null){
								$(".integral-zong").html(parseInt(res1))
							}else{
								$(".integral-zong").html(parseInt(res1)+parseInt(res2))
							}	
						})	
					}	
				})*/
				newCredit.GetTotal({'token':user.utoken()},function(res){
					//console.log(JSON.stringify(res))
					if(res.error_no==401){
						mui.confirm("您的账号已在另一台设备登录，请重新登陆，如非本人操作，建议尽快修改密码","提醒",["确定"],function(e) {
							if (e.index == 0) {
								login();
							}
						})
					}
					if(res){
						//var html = template('tpl',res.result);
						if(res.result==false){
							$(".integral-zong").html(0);
						}else{
							$(".integral-zong").html(res.result.current);
						}
					}else{
						
					}
				})
				
				//判断是否签到
				req2={'username': store.get('username'),
					 'limit':1,
					 'nid':'sign'
				};
				credit.GetLogList({'request':req2},function(res){
					var nowDate=new Date().getTime()+28800000
					var remainDate=nowDate-nowDate%86400000-28800000
				//	console.log(remainDate)
					if(res==""){
						$("#getSign").css("display","block")
						$('.integral-yqd').css("display","none")
					}
					else{
						if(parseInt(remainDate/1000)>parseInt(res[0].addtime)){
							$("#getSign").css("display","block")
							$('.integral-yqd').css("display","none")
						}else{
							$('.integral-yqd').css("display","block")
							$("#getSign").css("display","none")
							//$("#getSign").css("display","block")
						}
					}
					mui('#pullrefresh').pullRefresh().endPulldownToRefresh();//refresh completed
				})		
			}
			mui.plusReady(function(){
				//mui('#pullrefresh').pullRefresh().setStopped(true) 
				//mui('#pullrefresh').pullRefresh().disablePullupToRefresh()
				pulldownRefresh()
				//mui('#pullrefresh').pullRefresh().pulldownLoading();
				document.addEventListener("top-right-btn",function(){
					mui.openWindow({
						url:'sign.html',
						id:'sign.html',
						styles:{popGesture:'close'},
						show:{autoShow:true,aniShow:'slide-in-right'},
						waiting:{autoShow:false}
					});
				})
				mui('body').on('tap','.integral-zong',function(e){
					mui.openWindow({
						url:'sign.html',
						id:'sign.html',
						styles:{popGesture:'close'},
						show:{autoShow:true,aniShow:'slide-in-right'},
						waiting:{autoShow:false}
					});	
				})
				mui('body').on('tap','.integral-botton',function(e){
					//console.log(JSON.stringify(res))
					e.stopPropagation()
					request={'user_id': user.uid()};
					credit.GetSign({'request':request},function(res){
						console.log(JSON.stringify(res))
						if(res.code==1){
							if(res.count=="15"){
								layer.open({
									title:[''],		
									content: '<div class="integral-tan">签到成功<p class="integral-chengg">获得额外奖励<span style="color:##F95453">200</span>积分</p><div class="integral-tan-bg"><span class="timer" data-to="'+res.value+'"  data-speed="50">99</span></div></div>',
									success:function(layero, index){
										scrollNum()	
									}
								});
							}else{
								layer.open({
									title:[''],		
									content: '<div class="integral-tan">签到成功<p class="integral-chengg">连续签到<span style="color:#F95453;font-weight:bold;">'+res.count+'</span>天</p><div class="integral-tan-bg"><span class="timer" data-to="'+res.value+'"  data-speed="1000">99</span></div></div>',
									success:function(layero, index){
										scrollNum()	
									}
								});	
							}
						}else{
							mui.toast(res.msg);
						}	
						pulldownRefresh()
					})	
				})
				mui('body').on('tap','#turnRule,.integral-tan-bg',function(e){
					e.stopPropagation()
					mui.openWindow({
						url:'integral_mall_rule.html', 
						id:'integral_mall_rule.html',
						styles:{popGesture:'close'},
						show:{autoShow:true,aniShow:'slide-in-right'},
						waiting:{autoShow:false}
					});	
				})
			})
		</script>
	</body>
</html>
