<!DOCTYPE html>
<html>
	<head>
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="format-detection" content="telephone=no, email=no" />
		<title>聚车金融</title>
		<link href="css/css.css" rel="stylesheet" type="text/css" />
		<link href="css/mui.min.css" rel="stylesheet"/>
		<link href="css/layer.css" rel="stylesheet"/>
		<link href="css/mylayer.css" rel="stylesheet"/>
	</head>
    <style type="text/css">
	    .mui-loader {
			position: absolute;
			top: 25%;
			width: 100%;
			height: 60%;
			color: #888;
			font-size: 14px;
			text-align: center;
		}
		.header{
			width:100%;
			height:45px;
			background:#fff;
			text-align:center;
			font-size:0px;
			line-height:0px;
			position:fixed;
			z-index:999;
			left:0;
			top:0;
			b-webkit-box-sizing:border-box;
			-o-box-sizing:border-box;
			-ms-box-sizing:border-box;
			box-sizing:border-box;
			}
		.header:after{
			width:100%;
			height:1px;
			position:absolute;
			left:0;
			bottom:0;
			background:#e6e5e5;
			content:"";
			font-size:0;
			}
		header .mui-icon { color: #999; font-size: 14px; }
		header .mui-title { color: #333; }
		    	#main-box img { max-width: 100%;}
		    	
		.mui-loader { color: #999; line-height: 20px; font-size: 12px; padding-top: 50px; }
		
		.mui-table-view {}
		.mui-table-view:after,.mui-table-view:before { height: 0px; }
		.mui-table-view-cell:after { left: 0px; }
		.mui-table-view-cell { color: #666666; font-size: 12px; }
		
		.mui-table-view-cell .dsp { right: 80px; position: absolute; }
		.mui-table-view-cell i { right: 50px; top: 10px; position: absolute; }
		
		.mui-card { border: 0; margin: 5px 0; }
		
		.mui-input-group .mui-input-row { color: #666666; font-size: 12px; }
		.mui-input-group:after,.mui-input-group:before { height: 0px; background: transparent; }
		.mui-input-group .mui-input-row:after { left: 0; }
		.mui-input-group .mui-input-row i { right: 50px; top: 10px; position: absolute; }
		.mui-input-group .mui-input-row  .dsp { right: 80px; position: absolute; }
		.moneyfont{ font-size:16px;color:#f13f3f;}
		
		.mui-popover {
			height: 300px;
		}
		.aleTelNum{
			margin-top:-10px;
		}
		.aleTelPri{
			height:50px;
			line-height: 50px;
		}
		.layermend {
			 display: ;
		}
		/*.layer-wjmm:active{
			border-bottom: 1px solid #E56059 ;
			color:#E56059;
		}*/
		.moneyList{
			color: #333;
			position: relative;
			padding:0 10px 0px 20px;
			font-size: 16px;
			height: 50px;
			line-height: 50px;
			background-color: #fff;
		}
		.moneyList:after{
			content: "";
			position: absolute;
			height: 1px;
			width: 90%;
			bottom: 0;
			left: 20px;
			-webkit-transform: scaleY(.5);
			transform: scaleY(.5);
			background-color:#E4E4EA ;
		}
		.mui-input-row.moneyList:after{
			height: 0;
		}
		.mui-input-row label{
			font-family:"microsoft yahei";
			padding:0px;
			line-height: 50px;
		}
		.mui-input-row input{
			padding:0px;
			height:30px;
			line-height: 0px;
			margin-top:10px;
			font-weight: bold;
			font-size: 17px;
		}
		.mui-input-row button{
			right:15px;
			width:60px;
			height:30px;
			margin-top:10px;
			line-height: 30px;
			border-radius: 15px;
		}
		.yearEarnings{
			padding-left: 20px;
			line-height: 40px;
			
		}
		.exit-opn{
			padding:20px 20px;
		}
		.exit-opn .btn{
			font-size: 16px;
			height: 45px;
			background-color: #e94f4f;
		} 
		#btn_submit:active{
			background: #E56059;
		}
		#hongbao-offCanvas,#jxj-offCanvas{
			color: #333;
			font-size: 16px;
			padding:17px 20px;
		}
		#qetx{
			background-color: #ff9900;
		}
		#hongbao,#jxj{
			padding-right: 25px;
			background: url(images/jt_right.png) no-repeat right center;
			background-size: 24px 24px;
		}
		.yuandian{
			display: inline-block;
			vertical-align: middle;
			width: 10px;
			height: 10px;
			background-color: #E4393C;
			border-radius: 50%;
			margin-right: 15px;
		}
    </style>
	<body>
		<!--侧滑菜单容器-->
		<div id="offCanvasWrapper" class=" mui-draggable">
			<!--菜单部分-->
			<aside id="offCanvasSide" class="mui-off-canvas-right" style="width: 50%; background: #fff;">
				<div id="offCanvasSideScroll" class="mui-scroll-wrapper">
					<div class="mui-scroll" style="padding-bottom: 45px;">	
						<!--<button id="offCanvasHide" type="button" class="mui-btn mui-btn-block" style="padding: 5px 20px;">关闭</button>-->
						<div class="title mui-btn-danger" style="margin-bottom: 10px; line-height: 50px; text-align: center; color: #fff;">我的红包</div>
						<ul class="mui-table-view" id="hongbaolist">
						</ul>
					</div>
				</div>
			</aside>
			<div class="mui-inner-wrap">
				<header class="mui-bar mui-bar-nav header">
					<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
					<a id="top_right_btn" class="mui-pull-right" style="display: none;"></a>
					<h1 id="title" class="mui-title">投资产品</h1>
				</header>
				<div id="offCanvasContentScroll" class="mui-content mui-scroll-wrapper" >
					<div class="mui-loader" id="mui-loader">
						<span class="mui-spinner"></span> <span id="loading-text" class="mui-hidden">请耐心等候</span>
					</div>
					<div class="mui-scroll" id="templateLj" style="display: none;">						
					</div>
				</div>
				<!-- off-canvas backdrop -->
				<div class="mui-off-canvas-backdrop"></div>
				<input type="hidden" name="jxnum" id="jxNum" value="0" />
			</div>
		</div>
		<script type="text/html" id="tpl">
			<input type="hidden" name="borrow_nid" id="borrow_nid" value="0" />
			<input type="hidden" name="borrow_apr" id="borrow_apr" value="0" />
			<input type="hidden" name="borrow_period" id="borrow_period" value="0" />
			<input type="hidden" name="borrow_style" id="borrow_style" value="" />
			<div id="borrow_account_wait" style=" display:none;"></div>	
			<div id="ktje" class='moneyList'>可投金额：<span  id="span_borrow_account">{{borrow.borrow_account_wait}}</span>元	<a style="float: right; color: #999;font-size: 13px;">（100元起投）</a></div>
			<div class='moneyList'>账户余额：<span class="moneyfont" id="balance">0.00</span><span style="color:#f13f3f ;">元</span></div>
			<div class="mui-input-row moneyList">
				<label style="width: auto;">投资金额：</label>
				<input style="float: left;width: 40%;" type="number" pattern="[0-9]*" id="money" name="money"  value="" />元
				<button type="button" class="qetx-qetz" id="qetx">全投</button>
				<div style="clear: both;"></div>
			</div>
			<p class="yearEarnings">年化收益：<span id="earningsMoney">{{borrow.borrow_apr}}</span>%，&nbsp;到期收益：<span id="span_borrow_sy">0.00</span>元</p>
			<ul class="mui-table-view mui-table-view-striped mui-table-view-condensed select-box" style="margin:10px 0;background: #EFEFF4;"> 
				<li class="mui-table-view-cell select-coupon go-hongbao" data={"url":"use_hongbao.html","name":"hongbaoPage"} id="hongbao-offCanvas" style="padding-right: 12px;background: #fff;">
			        <div class="mui-table">
			            <div class="mui-table-cell mui-col-xs-4">
			            	<span class="name">红包</span>
			            </div>
			            <div class="mui-table-cell mui-col-xs-8 mui-text-right">
			                <span class="c5" id="hongbao">未选择</span>
			                <input type="hidden" name="hmoney" id="hmoney" value="0" />
			            </div>
			        </div>
		    	</li>
		    	<li class="mui-table-view-cell select-coupon" data="{'url':'use_coupon.html','name':'couponPage'}" id="jxj-offCanvas" style="padding-right: 12px;margin-top:10px;background: #fff;">
			        <div class="mui-table">
			            <div class="mui-table-cell mui-col-xs-4">
			            	<span class="name">加息劵</span>
			            </div>
			            <div class="mui-table-cell mui-col-xs-8 mui-text-right">
			            	{{if coupon_tip}}
			            	<span class="c5" id="jxj"><a class="yuandian"></a>您有一张VIP加息券</span>
			            	{{else}}
			                <span class="c5" id="jxj">未选择</span>
			                {{/if}}
			                <input type="hidden" name="jxmoney" id="jxmoney" value="0" />
			                <input type="hidden" name="jxrate" id="jxrate" value="0" />
			            </div>
			        </div>
		    	</li>
		    </ul>
			<div class="exit-opn"><button class="btn" id="btn_submit">确认支付</button></div>
		</script>
		<script type="text/html" id="tpl-hongbao-item">
				<li class="mui-table-view-cell">
					<a class="mui-navigate-right" data-value="0" data-id='0' data-money='0'>
						不使用红包
					</a>
				</li>
			{{each list as $item i}}
				<li class="mui-table-view-cell">
					<a class="mui-navigate-right hbNum" data-value="{{$item.id}}-{{$item.money}}" data-id='{{$item.id}}' data-money='{{$item.money}}'>
						{{$item.money}}元红包	&nbsp;&nbsp;<span style="color: #999;font-size: 9px;">{{$item.tday}}过期</span>
					</a>
				</li>
			{{/each}}
		</script>
		<script src="js/jquery-1.11.2.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/layer.js"></script>	
		<script src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/jQuery.md5.js" ></script>
		<script src="js/common.js"></script>
		<script src="js/api.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/template.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/template.function.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript"> 
			mui.init({
				swipeBack: true,
				beforeback: function(){
					//获得a界面的webview
					//var thisIndex= plus.webview.getWebviewById('pshow.html');
					var thisIndex= plus.webview.currentWebview().opener();
	//				//触发a的自定义事件（refresh）,从而进行数据刷新
					mui.fire(thisIndex,'refresh');
					//返回true，继续页面关闭逻辑
					return true;
				}
			})
			/****自动获取焦点弹窗native.js****/
		  	var nativeWebview, imm, InputMethodManager;
			var initNativeObjects = function() {
			    if (mui.os.android) {
			        var main = plus.android.runtimeMainActivity();
			        var Context = plus.android.importClass("android.content.Context");
			        InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
			        imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
			    } else {
			        nativeWebview = plus.webview.currentWebview().nativeInstanceObject();
			    }
			};
			var showSoftInput = function(){
				var nativeWebview = plus.webview.currentWebview().nativeInstanceObject();
			    if (mui.os.android) {
			    	//强制当前webview获得焦点
			        plus.android.importClass(nativeWebview);
			        nativeWebview.requestFocus();
			        imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
			    } else {
			        nativeWebview.plusCallMethod({
			            "setKeyboardDisplayRequiresUserAction": false
			        });
			    }
			    setTimeout(function() {
			       //此处可写具体逻辑设置获取焦点的input
			       var inputElem = document.querySelector('#money');
			              inputElem.focus(); 
			    }, 400);
			};
			//弹窗软键盘
			var showTcInput = function() {
				var nativeWebview = plus.webview.currentWebview().nativeInstanceObject();
			    if (mui.os.android) {
			    	//强制当前webview获得焦点
			        plus.android.importClass(nativeWebview);
			        nativeWebview.requestFocus();
			        imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
			    } else {
			        nativeWebview.plusCallMethod({
			            "setKeyboardDisplayRequiresUserAction": false
			        });
			    }
			    setTimeout(function() {
			       //此处可写具体逻辑设置获取焦点的input
			       var inputElem = document.querySelector('.pwd-input');
			              inputElem.focus(); 
			    }, 400);
			};	
			/*结束*/
			mui.plusReady(function(){ 
				initNativeObjects();
				//获取红包
				hbrequest = {};
				hbrequest = {'user_id': user.uid()};
				hbrequest.status = 1;
				user.GetHongbao({'request':hbrequest},function(res){					
					var html = template('tpl-hongbao-item',res);
					document.getElementById("hongbaolist").innerHTML = html;
				})
				var use_hbmoney;
				var hasVip = false;
				coupon.GetCouponList({"token":user.utoken(),"status":"1"},function(res){
					console.log(JSON.stringify(res))
					if(res.error_no==200){
						var coupon_num = res.result.total
						if(res.result.total==0){
							vipcoupon_data = {
								cid:"",
								etime:"",
								crate:"",
								auto_use:2
							}
						}else{
							for(var i in res.result.rows){
								var row = res.result.rows[i]
								if (row.type == 'vip'){
									coupon_num-=1
									hasVip = true;
									vipcoupon_data = {
										cid:row.coupon_user_id,
										etime:1498838399,
										crate:row.rate,
										auto_use:row.is_auto_use
									}
								}else{
									
								}
							}
						}

						if(!hasVip){
							vipcoupon_data = {
								cid:"",
								etime:"",
								crate:"",
								auto_use:2
							}
						}
						$("#jxNum").val(coupon_num)
					}
				})
				document.addEventListener('ljback',function(){
					plus.webview.currentWebview().reload(true)
				})
				
				
				
				//选择红包返回
				document.addEventListener('getHongbao',function(e){
					//console.log(e.detail)
					var hb_id = ""
					arr_hbdata = e.detail
					use_hbmoney = 0;
					var big = 999;
					for ( var i in arr_hbdata){
						if(i == 0){
							hb_id +=arr_hbdata[i].hbvalue 
						}else{
							hb_id +=","+arr_hbdata[i].hbvalue
						}
						use_hbmoney += parseInt(arr_hbdata[i].money)
						//console.log(arr_hbdata[i].tday.split("天")[0])
						if (parseInt(arr_hbdata[i].tday.split("天")[0]) < big){
							big = parseInt(arr_hbdata[i].tday.split("天")[0]) 
						}	
					}
					$("#hmoney").val(hb_id);
					if(use_hbmoney > 0){
						var hbmsg = use_hbmoney+"元红包"+"<span style='color:#999;font-size:12px;'>（"+big+"天过期）</span>"
						$("#hongbao").html(hbmsg);
						//console.log($("#hmoney").val())
					}else{
						$("#hongbao").html("未选择");
					}
					
				})
				
				
				//TODO
				//选择加息劵返回
				document.addEventListener('getCoupon',function(e){
					var cid = e.detail.cid
					var c_etime = e.detail.etime
					var crate = e.detail.crate 
					$("#earningsMoney").html((oldEarnMoney + parseFloat(crate)).toFixed(2) )
					$("#borrow_apr").val(oldEarnMoney + parseFloat(crate)) 
					var jxmsg = crate+"%加息劵"+"<span style='color:#999;font-size:12px;'>（"+c_etime+"天过期）</span>"
					$("#jxj").html(jxmsg);
					$("#jxmoney").val(cid);
					$("#jxrate").val(crate)
					//请求收益
					var moneyvalue  = $("#money").val();
					var request = {};
					var borrow_apr = $("#borrow_apr").val();
					request.borrow_nid = borrow_nid;
					request.borrow_apr = borrow_apr;
					request.borrow_period = borrow_period;
					request.borrow_style = borrow_style;
					request.money = moneyvalue;
					borrow.sy({'request':request},function(res){
						if(res) {
							$('#span_borrow_sy').html(res);
						}else{
							$('#span_borrow_sy').html("0.00"); 
						}
					})
				})
				document.addEventListener('changeVipCoupon',function(e){
					coupon.GetCouponList({"token":user.utoken(),"status":"1"},function(res){
						if(res.error_no==200){
							for(var i in res.result.rows){
								var row = res.result.rows[i]
								if (row.type == 'vip'){
									vipcoupon_data.auto_use=row.is_auto_use	
								}
							}
							var moneyvalue  = $("#money").val();
							if(vipcoupon_data.auto_use==1&&parseInt(moneyvalue)>=100000){
								useVip()
							}else if(parseInt(moneyvalue)>=100000){
								changeJx()
								var moneyvalue  = $("#money").val();
								var request = {};
								$("#borrow_apr").val(oldEarnMoney)
								var borrow_apr = $("#borrow_apr").val();
								request.borrow_nid = borrow_nid;
								request.borrow_apr = borrow_apr;
								request.borrow_period = borrow_period;
								request.borrow_style = borrow_style;
								request.money = moneyvalue;
								borrow.sy({'request':request},function(res){
									if(res) {
										$('#span_borrow_sy').html(res);
									}else{
										$('#span_borrow_sy').html("0.00"); 
									}
								})
							}
						}
					})
					
				})
				
				var jxjPageTest = true
				mui("body").on("tap",".select-coupon,.go-hongbao",function(e){
					e.preventDefault();
					if(jxjPageTest){
						jxjPageTest = false;
						setTimeout(function(){
							jxjPageTest = true;
						}, 1000);
					}else{
						return false;
					}
					var hb_id = $("#hmoney").val()
					$('#money').blur()
					if($('#money').val()==""){
						mui.alert("请输入投资金额",function(){
				  			$("#money").focus()
						})
						
					}else{
						var urldata = this.getAttribute('data');
						//console.log(urldata)
						var urldata = eval("(" + urldata + ")");
						var urlpage = plus.webview.create(urldata.url,urldata.url,{popGesture:"close"},{"money":$("#money").val(),"hb_id":hb_id})
						setTimeout(function(){  
							urlpage.show("pop-in",300)
							if(urldata.url=='use_coupon.html'&&clear_coupon_tip){
								store.set('coupon_tip',1,3600*24*365)
							}	
						},200)
					} 
					
				})
				//END
				
				
				
				//提交
				mui('body').on('tap','#btn_submit',function(e){
					var money  = $("#money").val();
					var hmoney = $("#hmoney").val();
					var jxmoney = $("#jxmoney").val()
					var jxrate = $("#jxrate").val()
					if(jxrate == '0') jxrate='';
					else jxrate='+'+jxrate+'%';
					var hongbao;
					if(!use_hbmoney||use_hbmoney==0){ 
						hongbao="";
					}else{
						hongbao="(含"+use_hbmoney+"元红包)"
					}
					var request = {};
					request.token = user.utoken();
					request.borrow_id = borrow_nid;
					request.money = money;
					request.bouns_user_ids = hmoney;
					request.coupon_user_id = jxmoney
					request.from = 'app';
					if(money == ""){	
						//调用getdata()
						plus.nativeUI.alert('请输入投资金额！',function(){
							plus.webview.currentWebview().evalJS("window.scrollTo(0,0);");
				  			$("#money").focus()
						});
						return false;
					}
					
					if(parseFloat(money)%100!=0||parseInt(money)==0){
						plus.nativeUI.alert('投资金额必须100的倍数！',function(){
							plus.webview.currentWebview().evalJS("window.scrollTo(0,0);");
				  			$("#money").focus()
						});
						return false;
					} 
					//if(!use_hbmoney||use_hbmoney==0){
					if(!use_hbmoney||use_hbmoney==0){
						borrow.tender_bouns_recommend({'token':user.utoken(),'money':money,'borrow_id':borrow_nid},function(res){
							console.log('推荐'+JSON.stringify(res))
							if(res.error_no==200&&res.result.total > 0){
								mui.confirm('当前有可用优惠暂未使用，是否使用？',function(e){
									if(e.index == 0){//取消  
										tende_submit(request,money,biaoName,hongbao,jxrate)
									}else{//确认
										var defaultTab = document.getElementsByClassName('go-hongbao')[0]
										mui.trigger(defaultTab, 'tap');	
									}
								})
							}else{
								tende_submit(request,money,biaoName,hongbao,jxrate)
							}
						})
					}else{
						tende_submit(request,money,biaoName,hongbao,jxrate)
					}		
				});
				//全额投资
				mui('body').on('tap','#qetx',function(){	
					plus.webview.currentWebview().evalJS("window.scrollTo(0,0);");
					hbaomoney = $("#hongbaolist li");		
					var money = parseFloat($("#balance").html());	
					var borrow_apr = $("#borrow_apr").val();
					var account_wait = borrow_account_wait;
					var moneyb = parseInt(money/100);		
		            var moneyd = moneyb*100;	
					if(money>=100){
						if (money>account_wait){				
					        $("#money").val(account_wait);
					         moneyvalue  = account_wait;
					       // console.log(moneyvalue)
					       
						} else{
					        $("#money").val(moneyd);
					         moneyvalue  = moneyd;
					       // console.log(moneyvalue)
					    }
						changeHb(moneyvalue)
						changeJx()
						 				
					}else{
						 mui.alert('您的余额不足100，请充值！', function() {
		                    getdata(ljdata)
		                    plus.webview.currentWebview().evalJS("window.scrollTo(0,0);");
		               });	
					}
					var borrow_money  = $("#money").val();
					var request = {};
					request.borrow_nid = borrow_nid;
				//	request.borrow_apr = borrow_apr;
					request.borrow_period = borrow_period;
					request.borrow_style = borrow_style;
					request.money = borrow_money;
					
					
					if(vipcoupon_data.auto_use==1&&parseInt(moneyvalue)>=100000){
						var cid = vipcoupon_data.cid
						var c_etime = expireTime(vipcoupon_data.etime) 
						var crate = tofix2(vipcoupon_data.crate,vipcoupon_data.crate) 
						$("#earningsMoney").html((oldEarnMoney + parseFloat(crate)).toFixed(2) )
						$("#borrow_apr").val(oldEarnMoney + parseFloat(crate)) 
						var jxmsg = crate+"%加息劵"+"<span style='color:#999;font-size:12px;'>（"+c_etime+"天过期）</span>"
						$("#jxj").html(jxmsg);
						$("#jxmoney").val(cid);
						$("#jxrate").val(crate)
						//请求收益
						var borrow_apr = $("#borrow_apr").val();
						request.borrow_apr = borrow_apr;
					}else{
						
						$("#borrow_apr").val(oldEarnMoney);
						var borrow_apr = $("#borrow_apr").val();
						request.borrow_apr = borrow_apr;
					}
					//console.log(JSON.stringify(request));
					borrow.sy({'request':request},function(res){
						if(res) {
							$('#span_borrow_sy').html(res);
						}else{
							$('#span_borrow_sy').html("0.00");
						}
					})
					
				})
				/**********忘记密码页面跳转**********/
				mui('body').on('tap','#wjmm',function(e){
					e.preventDefault();
					layer.close(index)
					href=$(this).attr('data-href');
					inittemplate = getTemplate('template', 'template.html');
					//获得共用父模板
					var headerWebview = inittemplate.header;
						//获得共用子webview
					var contentWebview = inittemplate.content;
					contentWebview.loadURL(href);
					mui.fire(headerWebview, 'updateHeader', {
						title: '修改交易密码',
						showMenu: false
					});
					mui.fire(headerWebview, 'loading');
					headerWebview.show('slide-in-right', 150);
				});	
				//任何位置点击失去焦点
				document.addEventListener('tap',function(event){
					if(document.activeElement == document.getElementById("money") && event.target.id != 'money'){
						$('#money').blur();
					}
				})
				mui('body').on('keyup','#money',function(){
					
					use_hbmoney = 0;
					hbaomoney = $("#hongbaolist li");
					var moneyvalue  = $("#money").val();
					var request = {};
					request.borrow_nid = borrow_nid;
					request.borrow_period = borrow_period;
					request.borrow_style = borrow_style;
					request.money = moneyvalue;
					if(vipcoupon_data.auto_use==1&&parseInt(moneyvalue)>=100000){
						var cid = vipcoupon_data.cid
						var c_etime = expireTime(vipcoupon_data.etime) 
						var crate = tofix2(vipcoupon_data.crate,vipcoupon_data.crate) 
						$("#earningsMoney").html((oldEarnMoney + parseFloat(crate)).toFixed(2) )
						$("#borrow_apr").val(oldEarnMoney + parseFloat(crate)) 
						var jxmsg = crate+"%加息劵"+"<span style='color:#999;font-size:12px;'>（"+c_etime+"天过期）</span>"
						$("#jxj").html(jxmsg);
						$("#jxmoney").val(cid);
						$("#jxrate").val(crate)
						//请求收益
						var borrow_apr = $("#borrow_apr").val();
						request.borrow_apr = borrow_apr;
					}else{
						
						$("#borrow_apr").val(oldEarnMoney);
						var borrow_apr = $("#borrow_apr").val();
						request.borrow_apr = borrow_apr;
						//console.log(JSON.stringify(request));
						changeJx()
					}
					//判断红包
					changeHb(moneyvalue)
					borrow.sy({'request':request},function(res){
						if(res) {
							$('#span_borrow_sy').html(res);
						}else{
							$('#span_borrow_sy').html("0.00");
						}
					})
					
				})
				
				$('body').on('blur','#money',function(){
					var hbaomoney = $("#hongbaolist li");
					var moneyvalue = $("#money").val();//原为#money：text	
					if(!isNaN(moneyvalue)){
						var hbNum=0
						hbaomoney.each(function(){
						 var str = $(this).find('a').attr('data-value');
						  strs=str.substr(str.indexOf('-')+1,9);
						 if( (moneyvalue)*(0.01) < 20 ){//假如小于2000
						 	if ( (strs) > (moneyvalue)*(0.01) ){//达不到使用规则
								$(this).hide();
								//hbNum-=1
							}else{
								$(this).show();//第一个默认显示
								hbNum+=1
							}
						 }else{
						 	if ( (strs) > (moneyvalue)*(0.005) ){
								$(this).hide();
							}else{
								$(this).show();
								hbNum+=1
								}
							}
						});
					}
					//changeJx()
				})
				
				//投资
				function tende_submit(request,money,biaoName,hongbao,jxrate){
					var pwRequest = {'user_id':user.uid()}; 
					user.GetUsers({'request':pwRequest},function(pw){
						var	upayWord=pw.paypassword;
						if(upayWord==""){
							mui.confirm('请先设置交易密码','提醒',["取消","去设置"],function(e){
								if(e.index == 1){
									inittemplate = getTemplate('template', 'template.html');
									var headerWebview = inittemplate.header;
									var contentWebview = inittemplate.content;
									contentWebview.loadURL("set_paypassword.html");
									mui.fire(headerWebview, 'updateHeader', {
										title: '设置交易密码',
										showMenu: false
									});
									mui.fire(headerWebview, 'loading');
									headerWebview.show('pop-in', 300);
								}else{
									return false
								}
							})
						}else{
							function closelayer(){
								layer.close(index)
							}
							index =layer.open({
								title: [
							        '交易密码', 
									'text-align:center;padding:0px;margin:0;'
							    ],
							    content: '<p class="aleTelNum">投资&nbsp;'+biaoName+'</p><p class="aleTelPri">￥'+money+'.00<span style="font-size:12px;margin:0 3px;">'+hongbao+'</span><span style="color:#ffb100;font-size:12px;margin-left:2px">'+jxrate+'</span></p><div class="pwd-box"><input type="tel" class="pwd-input" id="pwd-input" maxlength="6"><div class="fake-box"><input type="password" readonly=""><input type="password" readonly=""><input type="password" readonly=""><input type="password" readonly=""><input type="password" readonly=""><input type="password" readonly=""></div></div><div class="tz-submit"><a class="tz-btn">确认投资</a></div><div class="layer-wjmm"><a id="wjmm" data-href="wjmmpay.html">忘记交易密码?</a></div>',
							    shadeClose: false,
							    anim:true,
							    success:function(layero, index){
									initNativeObjects();
									showTcInput();
									var $input = $(".fake-box input"); 
									var paypassword='';
							        $("#pwd-input").on("input", function() { 
							            var pwd = $(this).val().trim();  
							            for (var i = 0, len = pwd.length; i < len; i++) {  
							                $input.eq("" + i + "").val(pwd[i]);
							            } 
							            $input.each(function(){  
							                var index2 = $(this).index();  
							                if (index2 >= len) {  
							                    $(this).val("");  
							                }  
							           }); 
							            paypassword=$(this).val();
							    	})
							        
							        mui('.tz-submit').on('tap','.tz-btn',function(e){ 
							        	e.preventDefault();
							        	if (paypassword.length==6) {
							        		var nowTime = new Date().getTime();
							    			var clickTime = $(this).attr("ctime");
							    			if( clickTime != 'undefined' && (nowTime - clickTime < 3000)){
										        return false;
										    }else{
										    	$(this).attr("ctime",nowTime);
										    }
							        		request.pay_password_md5 = $.md5(paypassword)
											borrow.tenderAdd(request,function(res){
												//console.log(JSON.stringify(res));
												/*console.log(JSON.stringify(request));*/
												//plus.nativeUI.showWaiting();
												if(res.error_no == 200){
													//alert("投标成功");
													$("input").blur();
													closelayer()
													//plus.nativeUI.closeWaiting();
													data = {'article_id': borrow_nid};
													//跳转成功页面
													var tzcg=mui.openWindow({
														url:"tzcg.html",
														id:"tzcg.html",
														styles:{"aniShow":"slide-in-right","popGesture":"close"},
														waiting:{"autoShow":false},
														extras:{
															money:money,
															article_id: ljdata,
															nowtime :new Date().getTime() / 1000	
														}
													})
													mui.fire(plus.webview.getWebviewById("tzcg.html"), "mui.view.show",data);
													//return false;	
												}else if(res.error_no == 12001){//余额不足
													plus.nativeUI.closeWaiting();
													var btnArray = ['取消','确定'];
													mui.confirm('您的余额不足，请充值','', btnArray, function(e) {
														if (e.index == 1) {
															//充值界面			
															var	recharge=plus.webview.create('w_recharge.html','w_recharge.html',{'popGesture':'close'});
															setTimeout(function(){
																recharge.show("slide-in-right",150);
															},300);
															
															recharge.addEventListener('loaded',function(){
																mui.fire(recharge,'recharge',{
																	sale_price:parseInt(money)-parseFloat(yourBalance)
																});
															});
															closelayer()
															return false;
														} else {
															closelayer()
															getdata(ljdata)
															plus.webview.currentWebview().evalJS("window.scrollTo(0,0);");
															return false;
														}
													})
												}else if(res.error_no==2013){//交易密码错误
													mui.toast("密码错误")
													$("#pwd-input").focus()
													return false;
													
												}else{//错误码
													$("input").blur();
													closelayer()
													plus.nativeUI.alert(res.error_msg,function(){
														//plus.webview.currentWebview().reload()
														getdata(ljdata)
														plus.webview.currentWebview().evalJS("window.scrollTo(0,0);");
														
													});
												}
											})
								    	}else{
								    		mui.alert("请输入完整的交易密码",function(){
								    			$("#pwd-input").focus()
								    			return false;
								    		})
								    	}
							        })
			
								}
							})
						
						}
					})	
				}
				
				
				function changeHb(moneyvalue){
					$("#hmoney").val("");//金额变动清除选择红包
					if(!isNaN(moneyvalue)){
						var hbNum=0
						hbaomoney.each(function(){
						 var str = $(this).find('a').attr('data-value');
						  strs=str.substr(str.indexOf('-')+1,9);
						 if( (moneyvalue)*(0.01) < 20 ){//假如小于2000
						 	if ( (strs) > (moneyvalue)*(0.01) ){//达不到使用规则
								$(this).hide();
								//hbNum-=1
							}else{
								$(this).show();//第一个默认显示
								hbNum+=1
							}
						 }else{
						 	if ( (strs) > (moneyvalue)*(0.005) ){
								$(this).hide();
							}else{
								$(this).show();
								hbNum+=1
								}
							}
						});
						if((hbNum-1)>0){
							$("#hongbao").html((hbNum-1)+"个可用红包");
						}else{
							$("#hongbao").html("无可用红包");
						}
					}
				}
				
				//可用加息券
				function changeJx(){
					$("#jxrate").val('0')
					$("#jxmoney").val("");//金额变动清除选择加息券
					$("#earningsMoney").html(oldEarnMoney.toFixed(2))
					if(store.get('coupon_tip')){
						var moneyvalue = $("#money").val();//原为#money：text	
						var jxNum = $("#jxNum").val()
						if(!isNaN(moneyvalue)){
							if(moneyvalue >= 100000&&vipcoupon_data.auto_use==2){
								$("#jxj").html(parseInt(jxNum)+1+"个可用加息券");
							}else if(jxNum!=0){
								$("#jxj").html(jxNum+"个可用加息券");
							}else{
								$("#jxj").html("无可用加息券");
							}
						}	
					}
				}
			})
			//pshow传入请求数据	
			document.addEventListener('mui.view.show',function(e){
				var data = e.detail;
				getBalance()
				ljdata=data;
				getdata(data);
				var id = e.detail.id;//获得传递的参数ID标示
			},false);
			
			//方法
			function getBalance(){
				//获取账户余额
				request2 = {'user_id':user.uid()};
				account.GetOne({'request':request2},function(res2){
					yourBalance=res2.balance
				})
			}
			
			function getdata(data){
				var request = data;
				request.borrow_nid = data.article_id;
				product.detail({"request":request},function(res){
					coupon.GetCouponList({"token":user.utoken(),"status":"1"},function(res2){
						var hasVip = false
						for(var i in res2.result.rows){
							var row=res2.result.rows[i]
							if(row.length!=0||row.type=='type'){
								var hasVip = true
							}
						}
						if(!store.get('coupon_tip')&&hasVip){
							res.coupon_tip = true
						}else{
							res.coupon_tip = false
						}
						clear_coupon_tip = res.coupon_tip
						var html = template('tpl',res);
						document.getElementById("templateLj").innerHTML = html;
						oldEarnMoney = parseFloat(res.borrow.borrow_apr) 
						$("#borrow_apr").val(res.borrow.borrow_apr);
						//创建共用全局变量
						borrow_account_wait = parseInt(res.borrow.borrow_account_wait);
						borrow_nid = res.borrow.borrow_nid;
						borrow_apr = res.borrow.borrow_apr
						borrow_period = res.borrow.borrow_period
						borrow_style = res.borrow.borrow_style
						/***///todo
						biaoName=res.borrow.name;
						if(res){
							res.is_login = user.uid();
							res.nowtime = new Date().getTime() / 1000;
							if(parseFloat(res.borrow.borrow_account_wait)>100){
								$('#span_borrow_account').html(res.borrow.borrow_account_wait)
							}else{
								$('#span_borrow_account').html(res.borrow.borrow_account_wait)
							}
							document.getElementById("earningsMoney").innerHTML=res.borrow.borrow_apr
							if(typeof(yourBalance)=='undefined'){
								//获取账户余额
								request2 = {'user_id':user.uid()};
								account.GetOne({'request':request2},function(res2){
									//console.log(JSON.stringify(res));	
									$('#balance').html(res2.balance);	
								})
							}else{
								$('#balance').html(yourBalance);
							}
							
						}else{
							
						}
						$('#mui-loader').hide();
						$('#templateLj').show();
				  		showSoftInput();
						plus.nativeUI.closeWaiting();
						var self = plus.webview.currentWebview();
					})
					
				})	
			}
			function useVip(){
				var cid = vipcoupon_data.cid
				var c_etime = expireTime(vipcoupon_data.etime) 
				var crate = tofix2(vipcoupon_data.crate,vipcoupon_data.crate) 
				$("#earningsMoney").html((oldEarnMoney + parseFloat(crate)).toFixed(2) )
				$("#borrow_apr").val(oldEarnMoney + parseFloat(crate)) 
				var jxmsg = crate+"%加息劵"+"<span style='color:#999;font-size:12px;'>（"+c_etime+"天过期）</span>"
				$("#jxj").html(jxmsg);
				$("#jxmoney").val(cid);
				$("#jxrate").val(crate)
				//请求收益
				var moneyvalue  = $("#money").val();
				var request = {};
				var borrow_apr = $("#borrow_apr").val();
				request.borrow_nid = borrow_nid;
				request.borrow_apr = borrow_apr;
				request.borrow_period = borrow_period;
				request.borrow_style = borrow_style;
				request.money = moneyvalue;
				borrow.sy({'request':request},function(res){
					if(res) {
						$('#span_borrow_sy').html(res);
					}else{
						$('#span_borrow_sy').html("0.00"); 
					}
				})
			}
			function expireTime(date){
				var nowDate = new Date() 
				nowDate = (nowDate.getTime())/1000
				var expireTime = parseInt(date) - nowDate 
				if( expireTime > 86400){
					res = parseInt(expireTime/86400) + 1
				}else{ 
					res = 1
				}
				return res;
			}
			function tofix2(data,num){
				if(isNaN(data)) return data;
				num = num || 100;
				data = new Number(data);
				res =  data/100;
				if(data%100 == 0){
					res = res.toFixed(1)
				}else{
					 
				}
				return res;
			}
		</script>
	</body>
</html>