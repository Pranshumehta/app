<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/css.css" />
		<style>
			.mui-loader {
				position: absolute;
				top: 25%;
				width: 100%;
				height: 60%;
				color: #888;
				font-size: 14px;
				text-align: center;
			}
			.contact-box li{
				font-size: 14px;
				float: left;
				line-height: 35px;
				width: 33%;
			}
			
			
			.clear{
				clear: both;
			}
			.sh-address{
				color: ;
				font-size: 14px;
				line-height: 25px;
			}
			#OA_task{
				background-color: #EFEFF4;
			}
			#OA_task > li{
				background-color: #fff;
				margin-bottom:10px ;
			}
			.add-address{
				margin-top: 30px;
			}
			.add-address a{
				font-size: 16px;
				color: #fff;
				display: block;
				height:50px;
				line-height: 50px;
				text-align: center;
				background-color: #e4393c;
				opacity: 0.95;
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<div class="mui-loader" id="mui-loader">
				<span class="mui-spinner"></span>
				<span id="loading-text" class="mui-hidden">请耐心等候</span>
			</div>
			<div class="show-address" style="display: none;">
				<ul id="OA_task" class="mui-table-view">
				
				</ul>
				<div class="add-address">
					<a class="add-address-btn">
						添加收货地址
					</a>
				</div>
			</div>
			
		</div>
		<script id="tpl" type="text/html">
			{{each rows as item i}}
			<li class="mui-table-view-cell" data="{'address_id':'{{item.address_id}}','name':'{{item.name}}','mobile':'{{item.mobile}}','area':'{{item.area}}'}">
				<div class="mui-slider-right mui-disabled">
					<a class="mui-btn mui-btn-grey btn-default ">默认</a>
					<a class="mui-btn btn-del mui-btn-red ">删除</a>
				</div>
				<div class="mui-slider-handle">
					<div>
						<ul class="contact-box">
							<li >联系人：<span>{{item.name}}</span></li>
							<li style="text-align: center;"><span>{{item.mobile}}</span></li>
							{{if item.is_default=="1"}}
							<li class="c5" style="text-align: right;">默认地址</li>
							{{/if}}
							<div class="clear">	
							</div>
						</ul>
						<p class="sh-address mui-ellipsis">收货地址：<span>{{item.area}}</span></p>
					</div>
				</div>
			</li>
			{{/each}}
		</script>
		<script src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/api.js" ></script>
		<script src="js/jquery-1.11.2.min.js"></script>
		<script src="js/common.js"></script>
		<script src="js/template.js"></script>
		<script src="js/template.function.js"></script>
		<script type="text/javascript">
			mui.init();
			mui.plusReady(function(){
				mui('#pullrefresh').pullRefresh().setStopped(true)
				getAddress()
				document.addEventListener("initpage",function(){
					getAddress()
					window.scrollTo(0,0);
				})
				mui('#OA_task').on('tap', '.btn-del', function(event) {
					var elem = this;
					var li = elem.parentNode.parentNode;
					var data = li.getAttribute('data');
					data = eval("(" + data + ")");
					var requestDel={"token":user.utoken(),"address_id":data.address_id+""}
					//console.log(JSON.stringify(requestDel))
					address.DelAddress(requestDel,function(res){
						//删除地址
						if(res.error_no==401){
							user.logout({},function(res){
								mui.confirm("您的账号已在另一台设备登录，请重新登陆，如非本人操作，建议尽快修改密码","提醒",["确定"],function(e) {
									if (e.index == 0) {
										login();
									}
								})
							});
						}else if(res.error_no==200){
							console.log("删除地址"+JSON.stringify(res))
							li.parentNode.removeChild(li);
						}else{
							plus.nativeUI.toast(res.error_msg)
						}
						 
					})
						
				});
				mui('#OA_task').on('tap', '.btn-default', function(event) {
					var elem = this;
					var li = elem.parentNode.parentNode;
					var data = li.getAttribute('data');
					data = eval("(" + data + ")");
					//使用add地址模拟添加默认地址
					var requestDef={"token":user.utoken(),"is_default":"1","address_id":data.address_id+""}
					//console.log(JSON.stringify(requestDef))
					address.UpdateAddress(requestDef,function(res){
						console.log(JSON.stringify(res))
						if(res.error_no==401){
							user.logout({},function(res){
								mui.confirm("您的账号已在另一台设备登录，请重新登陆，如非本人操作，建议尽快修改密码","提醒",["确定"],function(e) {
									if (e.index == 0) {
										login();
									}
								})
							});
						}else if(res.error_no==200){
							//刷新页面
							getAddress()
							window.scrollTo(0,0);
						}else{
							plus.nativeUI.toast(res.error_msg)
						}
						
						
					})
					
					//li.parentNode.removeChild(li);
				});
				mui('.add-address').on('tap', '.add-address-btn', function(event) {
					mui.openWindow({
						id:"add_address.html",
						url:'add_address.html',
						styles:{popGesture:'close'},
						waiting:{autoShow:false}	
					})
				});
				
				
				function getAddress(){
					var request={}
					request.token=user.utoken()
					address.Getlists(request,function(res){
						console.log(JSON.stringify(res))
						if(res){
							var html = template('tpl',res.result);
							$("#OA_task").html(html)
							$('#mui-loader').hide();
							$('.show-address').show();
						}else{
							
						}
					})
				}
				
			})
		</script>
	</body>

</html>