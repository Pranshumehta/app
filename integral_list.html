<!DOCTYPE html>
<html>
	<head>
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="format-detection" content="telephone=no, email=no" />
		<title>聚车金融</title>
		<link rel="stylesheet" href="css/mui.min.css">
	    <link href="css/css.css" rel="stylesheet" type="text/css" />
	    <link rel="stylesheet" href="css/iphone.css" />
	    <style>
	    	.hkjl-list { 
	    		padding: 0 10px;
	    	}
	    	.mui-table h4{
		        line-height: 25px;
		        font-weight: 500;
			}
			.mui-table-view-cell:after {
				left: 0px;
			}
			#yueSe{
				line-height: 40px;
				padding-left: 18px;
				font-size: 16px;
				color: #333;
				background: #EFEFF4;	
			}
			.mui-scroll{
				top:-40px;	
			}
			/*.mui-pull-bottom-pocket{
				bottom: -40px;
			}*/
	    </style>
	</head>
	<body>
		<div class="mui-content">
			<!--下拉刷新容器-->
			<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
				<div class="mui-scroll">
	
				</div>
			</div>
		</div>
	
		<script src="js/jquery-1.11.2.min.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/api.js"></script>
		<script type="text/javascript" charset="utf-8">  
	    	var curr_page = 0;
			mui.init({
				pullRefresh: {
					container: '#pullrefresh',
					down: {
						callback: pulldownRefresh
					},
					up: {
						contentrefresh: '正在加载...',
						callback: pullupRefresh
					}
				}
			});			
			/*
			 * 下拉刷新具体业务实现
			 */
			function pulldownRefresh() {
				setTimeout(function() {
					curr_page = 1;
					//clearOldList()
					getdata(curr_page);
				}, 100);
			}
			var count = 0;
			/**
			 * 上拉加载具体业务实现
			 */
			function pullupRefresh() {
				setTimeout(function() {
					//mui('#pullrefresh').pullRefresh().endPullupToRefresh(); //参数为true代表没有更多数据了。
					curr_page = curr_page + 1;
					getdata(curr_page);
				}, 100);
			}
			if (mui.os.plus) {
				mui.plusReady(function() {
					setTimeout(function() {
						mui('#pullrefresh').pullRefresh().pullupLoading();
					}, 100);
				});
			} else {
				mui.ready(function() {
					mui('#pullrefresh').pullRefresh().pullupLoading();
				});
			}
			function getdata(page){
				request = {'user_id':user.uid(),'size':10,'token':user.utoken()};
				request.page = page;
				newCredit.GetLogList(request,function(res){//$data和回调函数
					//mui('#pullrefresh').pullRefresh().setStopped(false)
					if(page==1){
						$(".mui-scroll").html("").css("top","0")	 
						mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
						mui('#pullrefresh').pullRefresh().refresh(true);
					}
					var upflag = page*10 >= res.result.total? true : false;
					mui('#pullrefresh').pullRefresh().endPullupToRefresh(upflag);
					// console.log(JSON.stringify(res));  
					$(res.result.rows).each(function(k,val){
						time=new Date(parseInt(val.create_time)*1000)
						year=time.getFullYear()
						yue=time.getMonth()+1
						addtime=getTime(val.create_time,"yyyy-MM-dd hh:mm")
						if(parseInt(val.num)<0){
							numChange=parseInt(val.num)
						}else{
							numChange="<span style='color:#26B3E1'>+"+parseInt(val.num)+"</span>"
						} 
						if(!$('.mui-scroll').find('.y-'+yue).length){
							$(".mui-scroll").append("<h5 id='yueSe' class='x-"+year+" y-"+yue+"'>"+year+"年"+yue+"月份</h5>"+
							"<ul id='zjjl-list' class='mui-table-view mui-table-view-striped mui-table-view-condensed year-"+year+" yy-"+yue+"'>"+
							"</ul>"
							)
						}
						if(val.type.nid=="sign"&&val.create_time > 1483592400){
							var sign_num = "(第"+val.sign+"天)"
						}else{
							var sign_num = ""
						}
						$(".year-"+year+".yy-"+yue).append(
							"<li class='mui-table-view-cell'>"+
								"<div class='mui-table'>"+
									"<div class='mui-table-cell mui-col-xs-6'>"+
										"<h4 class='mui-ellipsis' style='color: #333;font-size: 15px;'>"+val.remark+"<span style='color:#999;font-size:14px'> "+sign_num+"</span></h4>"+
										"<h5 style='line-height:18px;'>"+addtime+"</h5>"+
									"</div>"+
									"<div class='mui-table-cell mui-col-xs-6 mui-text-right'>"+
										"<p class='c5'><span></span>"+numChange+"</p>"+
										"<span class='mui-h5' style='color: #333;'>"+
											val.type.name+ 
										"</span>"+
									"</div>"+
								"</div>"+
							"</li>"
						)
					})

					if(res.result.total == 0){
						document.querySelector(".mui-content").innerHTML = '<div class="notes-box">'+
							'<i class="notes-moblie"></i>'+
							'<p class="no-records-size">暂无记录</p>'+
							'</div>';
						mui('#pullrefresh').pullRefresh().disablePullupToRefresh();
					}
				});
			}
			oldback = mui.back;
			mui.back = function(){
				//console.log("as");
				var parentPage=plus.webview.currentWebview().opener()
				mui.fire(parentPage,"initpage")
				oldback();
			}
			function  getTime(date, format) {
			    date = new Date(date * 1000);
			    var map = {
			        "M": date.getMonth() + 1, //月份 
			        "d": date.getDate(), //日 
			        "h": date.getHours(), //小时 
			        "m": date.getMinutes(), //分 
			        "s": date.getSeconds(), //秒 
			        "q": Math.floor((date.getMonth() + 3) / 3), //季度 
			        "S": date.getMilliseconds() //毫秒 
			    };
			    format = format.replace(/([yMdhmsqS])+/g, function(all, t){
			        var v = map[t];
			        if(v !== undefined){
			            if(all.length > 1){
			                v = '0' + v;
			                v = v.substr(v.length-2);
			            }
			            return v;
			        }
			        else if(t === 'y'){
			            return (date.getFullYear() + '').substr(4 - all.length);
			        }
			        return all;
			    });
			    return format;
			}
	    </script>
	                       
	</body>
</html>